events { worker_connections 1024; }

http {

    # --- 4.1 Persistência de Cache ---
    # Define a zona de memória (my_cache) e o diretório para armazenamento físico
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;

    # --- 3.3 Rate Limiting ---
    # Implementa a limitação de 5 requisições por segundo por IP
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=5r/s;

    # --- 3.5 Compressão GZIP ---
    # Ativa a compressão GZIP para otimizar o tráfego de payloads JSON e texto
    gzip on;
    gzip_types application/json text/plain;
    gzip_min_length 256; # Opcional: evita comprimir ficheiros muito pequenos

    # --- 3.6 Log Estruturado ---
    # Configuração para registrar IP, Método, Status e Tempo de Resposta do Upstream
    log_format estruturado 'IP:$remote_addr | Metodo:$request_method | '
                               'Status:$status | Instancia:$upstream_addr | '
                               'Upstream_Time:$upstream_response_time | Path:$request_uri';
    access_log /var/log/nginx/access.log estruturado;

    # --- 3.1 & Balanceamento de Carga ---
    # Implementa o Reverse Proxy com balanceamento entre 2 instâncias da API
    upstream api_java {
        server api-biblioteca1:8080;
        server api-biblioteca2:8080;
    }

    # --- 4.3 Redirecionamento Automático ---
    # Escuta na porta 80 e encaminha para HTTPS (Porta 443)
    server {
        listen 80;
        server_name localhost;
        return 301 https://$host$request_uri;
    }

    server {
        listen 443 ssl;
        server_name localhost;

        # --- 4.3 Certificados SSL ---
        # Configuração do protocolo seguro utilizando certificados autoassinados
        ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;

        # --- 3.4 Limite de Payload ---
        # Restringe o tamanho máximo do body da requisição para 1MB
        client_max_body_size 1M;

        # --- 4.4 Páginas de Erro Personalizadas ---
        # Tratamento customizado para erros de navegação (404) e servidor (50x)
        error_page 404 /404.html;
        location = /404.html {
            root /usr/share/nginx/html/errors;
            internal;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html/errors;
            internal;
        }

        # --- 3.2 Headers de Segurança ---
        # Adiciona proteções contra Sniffing, Frame Injection e XSS
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;

        location / {
            # Aplica o Burst permitido de 10 requisições
            limit_req zone=api_limit burst=10 nodelay;
            # Personaliza o erro de limite excedido (padrão é 503)
            limit_req_status 429;

            proxy_pass http://api_java;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- 4.1 Cache específico para /libraries ---
        location /libraries {

            limit_req zone=api_limit burst=10 nodelay;
            limit_req_status 429;

            # Ativa o cache
            proxy_cache my_cache;

            # Cachear apenas GET com sucesso por 10 segundos
            proxy_cache_methods GET;
            proxy_cache_valid 200 10s;

            proxy_ignore_headers Cache-Control Expires Set-Cookie;

            # Não cachear requisições autenticadas (Ex: Header Authorization ou Cookie)
            proxy_cache_bypass $http_authorization $cookie_session;
            proxy_no_cache $http_authorization $cookie_session;

            # Header informativo para testar se o cache funcionou (HIT -> do chache ou MISS -> da API)
            add_header X-Proxy-Cache $upstream_cache_status;

            proxy_pass http://api_java;
            proxy_set_header Host $host;
        }

        # --- 4.2 Autenticação Básica ---
        # Proteção de endpoints sensíveis através do arquivo .htpasswd
        location ~ ^/(swagger-ui|actuator) {
                    auth_basic "Restricted Access";
                    auth_basic_user_file /etc/nginx/.htpasswd;

                    proxy_pass http://api_java;
                    proxy_set_header Host $host;
        }
    }
}